---
title: 'Project 1: regression 1'
author: "Urvan Christen, Amandine Goffeney, Joseph Vermeil, Lucile Vigué"
date: "March 20, 2019"
output:
  pdf_document:
    df_print: paged
    keep_tex: true
fontsize: 12pt
geometry: margin=2.5cm
header-includes:
- \usepackage{fancyhdr}
- \usepackage{wrapfig}
- \pagestyle{fancy}
- \fancyhead[LE,RO]{Christen, Goffeney, Vermeil, Vigué}
bibliography: bibliography.bib
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Load here the libraries and packages you need for the rest of the analysis.
library(tidyverse)
library("MASS")
library(GGally)
library(car) # contains the vif() and leveneTest() functions
library(gridExtra)
library(cowplot)
```

```{r, echo=FALSE, message=FALSE}
# Loading data
DATA_FILE = "fishermen_mercury.csv" # Location of the data csv file
dataset = read.csv(DATA_FILE) # Loading the data
dataset$MeHg <- NULL # We are asked not to use the variable MeHg
dataset$LogTotHg <- log(dataset$TotHg)
dataset$logFishmlwk <- log(dataset$fishmlwk + 1)

#Converting categorical variables into factors
dataset$fisherman <- factor(dataset$fisherman)
dataset$fishpart <- factor(dataset$fishpart)
```

```{r, include = F}
defOut <- knitr::knit_hooks$get("plot")  # save the default plot hook 
knitr::knit_hooks$set(plot = function(x, options) {  # set new plot hook ...
  x <- defOut(x, options)  # first apply the default hook
  if(!is.null(options$wrapfigure)) {  # then, if option wrapfigure is given ...
    # create the new opening string for the wrapfigure environment ...
    wf <- sprintf("\\begin{wrapfigure}{%s}{%g\\textwidth}", options$wrapfigure[[1]], options$wrapfigure[[2]])
    x  <- gsub("\\begin{figure}", wf, x, fixed = T)  # and replace the default one with it.
    x  <- gsub("{figure}", "{wrapfigure}", x, fixed = T)  # also replace the environment ending
  }
  return(x)
})
```


## Introduction

Mercury is a metal present in the environment whose harmful effects on human health are well assessed [@park2012human]. In a study led in 2000 [@al2000factors], scientists collected data on total mercury and methyl mercury levels in the hair of 100 fishermen of Kuwait, aged 16 to 58 years, comparing them to those of a control population of 35 non-fishermen, aged 26 to 35 years. The aim of this report is to analyse the factors influencing the levels of mercury in both populations. For the sake of simplicity, we will only focus on total Hg, leaving out methyl mercury, as both variables are strongly correlated.

```{r echo = F, warning = F, message = F, fig.width=3.5, fig.height = 3, fig.cap = "Boxplots of Hg levels", fig.align="right", wrapfigure = list("R", .35)}
#, out.width = ".7\\textwidth"
ggplot(dataset, aes(group=fisherman, y=TotHg, fill=fisherman)) + geom_boxplot() + labs(y = "Total Hg concentration in the hair (mg/g)") + scale_x_discrete() + scale_fill_discrete(name = "Population", labels = c("Control group", "Fishermen")) + theme_bw()
```

The dataset gathers information about six numerical variables (age, height, weight, number of fish meals per week and residence time in Kuwait) and two categorical ones (being a fisherman or not, fish consumption habits). There is no additional information about gender as all the participants in the study are males.


```{r, include=FALSE}
t.test(x=dataset[which(dataset$fisherman==1),]$TotHg, y=dataset[which(dataset$fisherman==0),]$TotHg, alternative = "greater", var.equal=FALSE)
```
A first insight at the data shows that the fishermen population exhibits higher levels of mercury in their hair. The significance of the difference between the means of both distributions is assessed by a _Welch Two Sample t-test_ with the alternative hypothesis that the fishermen population has a average greater level of mercury than the control population (_p_-value = 7.473e-05).

## Exploratory analysis

### Overview of the data 
Before fitting a model, let's have a look at the data. The following table shows the 8 possible values of _fishmlwk_ according to the 2 possible values of _fisherman_.
```{r, echo=FALSE, message=FALSE, include=FALSE}
ftable(table(dataset$fisherman, dataset$fishmlwk)) #, col.vars = c("1", "2", "3","4","5","6","7","8")
```

<div style= "float:right;position: relative; top: -80px;">
| | | | | | | | | |
|-|-|-|-|-|-|-|-|-|
|**Number of fish meal per week**| **0** | **1**|**2**|**3**|**4**|**7**|**14**|**21**|
|**Fishermen**|0|0|0|2|12|70|5|11|
|**Non-fishermen**|10|14|11|0|0|0|0|0|
</div>
First, let's notice that for some values, we have a very few people, for instance only 2 people eat fish 3 times a week. We see also that the data is really unbalanced, because the _fisherman_ and the _fishmlwk_ variable are very highly correlated: the non fishermen don't eat fish more than 2 times a week, whereas the fishermen don't eat fish less than 3 times a week. 
Besides, we face the same unbalanced pattern for the variables _age_ and _restime_.



```{r, echo=FALSE, message=FALSE, include=FALSE}
par(mfrow=c(1,3))
ggplot(dataset, aes(age, TotHg, colour = fisherman)) + geom_point() #+ scale_y_log10() + scale_x_log10() ##Uncomment for log scales
ggplot(dataset, aes(restime, TotHg, colour = fisherman)) + geom_point()
ggplot(dataset, aes(fishmlwk, TotHg, colour = fisherman)) + geom_boxplot()
#grid.arrange(plot1, plot2, plot3, ncol=3, nrow = 1)
```

### Multicolinearity 

To check whether we have multicolinear variables, we use the variance inflation factor (VIF). We set the following criteria: we keep only the variables that have a result below 5. We observe that all the variables have a variance inflation factor below 2, so we don't eliminate any variable, yet.

```{r ,echo=FALSE, message=FALSE, include=FALSE}
hg.form.full = TotHg~ fisherman + age + restime + height + weight + fishmlwk + fishpart 
#hg.form.full2 = TotHg~ (fisherman + age + restime + height + weight + fishpart)^2
#hg.form.full3 = TotHg~ (fisherman + age + restime + height + weight + fishpart)^3

vif(lm(hg.form.full,data=dataset))
#vif(lm(hg.form.full2,data=dataset))
#vif(lm(hg.form.full3,data=dataset))
```


## Model selection

Now we are going to use and compare the different methods of model selection to select the more relevant parameters to explain the TotHg variations within the population.

### Stepwise selection

The first attempt is a stepwise selection based on a formula with all the parameters except for _fisherman_. Indeed, the preliminary exploration has shown that the _fisherman_ variable have considerable impact on many of the other variables. Therefore to understand what is the reason behind the TotHg difference between the 2 groups, it seems natural to start with a model without the _fisherman_ variable.

```{r, echo=FALSE, message=FALSE, include=FALSE}
hg.form.step1 = TotHg ~ age + restime + height + weight + fishmlwk + fishpart
model1 <- stepAIC(lm(hg.form.step1,data=dataset), direction="both")
```
```{r, echo=FALSE, message=FALSE}
summary(model1)$coefficients
```

With stepwise selection, the selected model is : TotHg ~ weight + fishmlwk. The intercept and the two coefficients are very significant. Moreover the signs of the coefficients are not absurd: while it is not really intuitive that the weight coefficient should be positive or negative, the coefficient of _fishmlwk_ had to be positive, and it's the case here.

Now to determine possible differences between the fishermen and non-fishermen, a model based on the interactions between the _fisherman_ variable and all the others is proposed. This could show if a certain variable is very relevant concerning fishermen but less when it comes to non-fishermen, for instance. We also include the _fisherman_ variable itself, that will allow to include an adjustment term between the values of the intercepts of the two groups if it is relevant.

```{r, echo=FALSE, message=FALSE, include=FALSE}
hg.form.step2 = TotHg ~ fisherman + fisherman:(age + restime + height + weight + fishmlwk + fishpart)
model2 <- stepAIC(lm(hg.form.step2,data=dataset), direction="both")
```
```{r, echo=FALSE, message=FALSE}
summary(model2)$coefficients
```

The best model is now : TotHg ~ fisherman + fisherman:weight + fisherman:fishmlwk.
While the coefficients for fisherman1:weight and fisherman0:fishmlwk stays very significant, fisherman1:fishmlwk is barely significant and fisherman0:weight, fisherman1 and the intercept are far from being significant. Moreover, when looking at the values of the coefficients, it appears that for the non-fishermen, the number of fish meal per week has a very preponderant (and reliable) effect compared to the weight influence, while among fishermen, the contribution of weight is twice the one of fish meal per week. Eventually the value of the fisherman1 parameter is surprising: it implies that the fact of being a fisherman gives you -8.99 mg/g Hg. Yet this comes from the increased value of fisherman1:weight, which will make the overall Hg concentration more important among fishermen, as expected.

In order to check the dependency of the selected model to the selection technique, we have tried backward and forward selection and obtained similar models.


```{r include=FALSE}
hg.form.bwd = TotHg ~ fisherman:(age + restime + height + weight + fishmlwk + fishpart)
drop1(lm(hg.form.bwd, data = dataset), test="F")
#> Delete fisherman:fishpart

hg.form.bwd = TotHg ~ fisherman:(age + restime + height + weight + fishmlwk)
drop1(lm(hg.form.bwd, data = dataset), test="F")
#> Delete fisherman:age

hg.form.bwd = TotHg ~ fisherman:(restime + height + weight + fishmlwk)
drop1(lm(hg.form.bwd, data = dataset), test="F")
#> Delete fisherman:restime

hg.form.bwd = TotHg ~ fisherman:(height + weight + fishmlwk)
drop1(lm(hg.form.bwd, data = dataset), test="F")
#> Delete fisherman:height

hg.form.bwd = TotHg ~ fisherman:(weight + fishmlwk)
drop1(lm(hg.form.bwd, data = dataset), test="F")
#> All parameters are significant (p-value < 0.05)
```


```{r include=FALSE}
hg.form.fwd = TotHg ~ 1
add1(lm(hg.form.fwd, data=dataset), test="F", scope = ~ fisherman:(age + restime + height + weight + fishmlwk + fishpart))
#> Add fisherman:weight

hg.form.fwd = TotHg ~ fisherman:weight
add1(lm(hg.form.fwd, data=dataset), test="F", scope = ~ fisherman:(age + restime + height + weight + fishmlwk + fishpart))
#> Add fisherman:fishmlwk

hg.form.fwd = TotHg ~ fisherman:weight + fisherman:fishmlwk
add1(lm(hg.form.fwd, data=dataset), test="F", scope = ~ fisherman:(age + restime + height + weight + fishmlwk + fishpart))
#> No more significant (p-value < 0.05) parameter to add
```


## Results and discussion

Fit model (* fishermen) (I picked the model given by stepwise selection)

```{r, echo=FALSE, message=FALSE}
hg.form.selected=TotHg ~  - 1 + fisherman + fisherman:(weight + fishmlwk)
hg.lm.selected.model=lm(hg.form.selected, data=dataset)
hg.lm.selected.summary <- summary(hg.lm.selected.model)
hg.lm.selected.summary$coefficients
```

This regression shows several interesting results:

### Difference between fisherman and control populations

First, we get two coefficients very significantly different from 0 (_p_ < 0.001), both concerning fisherman population. The fact that there are less significant coefficients for non-fisherman population could be explained by several causes:

- The non-fisherman population could be too small to properly show the size effect of those observables.
- The non-fisherman population may not have settled long enough in the place to have repercussion on the mercury levels.

However, those are only suppositions in order to explain the distribution of the _p_-values, but none of them have been proven. Further experiments are needed in order to show whether or not those observables have a really different effect on both populations.

### Number of fish meals per week

On the other side, the number of meal composed of fish (_fishmlwk_) seems to be contributing to the mercury levels of both populations (_p_-values of `r format(hg.lm.selected.summary[["coefficients"]][5,4], digits=1)` for non-fisherman and `r format(hg.lm.selected.summary[["coefficients"]][6,4], digits=1)` for fisherman). However, we can see that there is a huge difference between the two contributions of a factor `r format(hg.lm.selected.summary[["coefficients"]][5,1]/hg.lm.selected.summary[["coefficients"]][6,1], digits=1)`. 

Here again, we can come up with some possible explanations, needing further inquiries:

- The distribution of _fishmlwk_ is very different between both populations and thus may lead to different coefficients if the effect of this observables is not truly linear (*e.g.* a logarithmic effect that could take some ceiling effects into account, *i.e.* the fact that past a certain dose, the hair cannot absorb more mercury).

- The observables does not reflect entirely the quantity of fish eaten, since one can eat more or less fish per meal. The weight of fish eaten per week, might be a more accurate observable to study.


Here again, more expriements are required to confirm or reject those hypotheses.


### Weight

However, the most significant coefficient is for _weight_ for fisherman population, with a _p_-value of `r format(hg.lm.selected.summary[["coefficients"]][4,4], digits=1, scientific=TRUE)`. This coefficient suggest a high positive correlation between the weight of the fisherman and the concentration of mercury in its hair. 

The fact that the weight has a positive influence on this concentration was unexpected, since a concentration and not an absolute quantity was measured. 

However, even though it was unexpected it has many possible explanations such as the fact that weight is much likely correlated with adiposity more susceptible to catch toxins than other tissues. Another explanation could be that the fatter, the more one eats and possibly ingests mercury that could fix in the hair; since hair weight isn't likely to be correlated with body weight, it could explain the high mercury concentration in hair. 

Here again, further experiments are needed in order to support or reject those hypotheses.


```{r, echo=FALSE, message=FALSE}
library(ggplot2)
# plot(hg.lm.selected.model, which=1) #residuals vs fitted
qplot(hg.lm.selected.model$fitted.values, hg.lm.selected.model$residuals, colour=dataset$fisherman, xlab = "fitted values", ylab = "residuals") + labs(colour = 'fisherman')
```
The model does not seem to be really homoscedastic. Variance is much higher for fishermen than for non-fishermen. However, within each class, the variance is overall well distributed, even if it tends to be a little more spread for high fitted values. But, since our model is split into two submodels corresponding to fisherman population and non-fisherman population, the difference of variances between both classes doesn't matter.


```{r, echo=FALSE, message=FALSE}
plot(hg.lm.selected.model, which=2) #QQ plot
```

We have a heavy tails distribution of residuals, with a very heavy right tail. The fact that we have two submodels merged in one might explain the heavy tails. However it cannot explain the difference between right and left tails. This could be caused by an insufficient sample size. Or it could be explained by a non-linear relation between the observables and the concentration of mercury, thus possibly unbalancing the residuals distribution. 

```{r, echo=FALSE, message=FALSE}
#plot(hg.lm.selected.model, which=3) #scale location
```


## Conclusion

We have achieved to build a simple model that can help explaining the levels of mercury observed in a fishermen population compared to a control group. It appears that the variables that have the most significant influence over the measured levels of mercury are the weight of the individual and the frequency at which they eat fish. The former can seem surprising even if some hypotheses can be formed to account for the influence of weight on mercury levels. The latter may be the main explanation for the differences observed between our two groups: fishermen use to eat fish much more often than non-fishermen, as fish is a well-known source of mercury it seems logical to see a positive correlation between fish meal frequency and mercury levels and thus to observe higher mercury levels in fishermen populations compared to non-fishermen.

## References